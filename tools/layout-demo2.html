<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
<head>
<title>Pseudo-MathJax Layout</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<style>
body {
	background-color: #fff;
}
h1 {
	font-size: 20pt;
}
label {
	background-color: #ccc;
	border: 2px solid #aaa;
	display: inline-block;
	margin: 0.2em; margin-left: 0;
	padding: 0.2em;
	border-radius: 4px;
	-moz-border-radius: 4px;
	-webkit-border-radius: 4px;
}
table {
	border-collapse: collapse;
	border: 1px solid #aaa;
	table-layout: auto;
	margin: 0.2em; margin-left: 0;
}
caption {
	width: auto;
	background-color: #ccc;
	border: 2px solid #aaa;
	padding: 0.2em;
	border-radius: 4px 4px 0 0;
	-moz-border-radius: 4px 4px 0 0;
	-webkit-border-radius: 4px 4px 0 0;
}
th, td {
	border: 1px solid #aaa;
	padding: 0.2em;
}
.hidden {
	display: none;
}
.exploratory {
	color: #fff;
}
#message {
	color: red;
	margin: 0;
}
</style>
<script src="ui.js"></script>
<script>
/*
 Basic Procedure
 NOTE all math HTML is pre-generated by MathJax in IE8
 1. Get all math frames and perform all the following steps on each
 2. Remove the frame from the document
 3. Traverse the equation DOM tree, building a map of pseudo-MathML-elements, listing all elements of the same depth together
 4. Every element is wrapped inside a span (or a div if the config asks for it)
 5. Insert the equation back into the DOM.
 Steps 6-9 are performed on every element. If the config calls for batch mode then each step is performed on all elements of the same depth
 before moving on to the next step.
 6. Measure height and width of the wrapper.
 7. Pad the element with a '{' character enclosed in a span
 8. Measure height and width of the wrapper
 9. Move the element out of the wrapper and remove the wrapper from the DOM
 
 Timings are taken for DOM preparation (steps 2-5) and adjustment (steps 6-9)
 
 It is not valid to compare MathJax processing time to this rebuilding, since
 - MathJax does a lot more work
 - This performance testing does a lot more element dimension lookups, which are expensive
 
 The only way to compare the two is to look at how much time is spent in offsetHeight, offsetWidth lookups.
 Timestamps on browsers have millisecond granularity (seems to effectively be 10ms on IE) which is too coarse for this investigation.
 You really have to use profiling tools on browsers that provide them - Firefox (with Firebug), Chrome, Safari and IE8. 
*/

var mui = MathJaxUI, $ = mui.$, $$ = mui.$$,
	extend = Object.extend, each = Object.each, forEach = Array.forEach, eachWord = String.eachWord;

// Default config
var config = {};

Object.extend(config, {
	equation: null,
	count: 1,
	batch: false,
	absPosWrapper: false,
	divWrapper: false,
	fixedPosFrame: false,
	mathRemoved: false,
	bookend: '<span style="width: 2em; height: 2em;">}</span>'
});

mui.getOptions(function(key, val) {
	val = decodeURIComponent(val);
	config[key] = val;
});

</script>
<style>
@font-face {
	font-family: MathJax_Main;
	src:url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/eot/MathJax_Main-Regular.eot);
	src:local('☺'),
		url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/otf/MathJax_Main-Regular.otf) format('opentype'),
		url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/svg/MathJax_Main-Regular.svg) format('svg');
}
@font-face {
	font-family: MathJax_Main-bold;
	src:url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/eot/MathJax_Main-Bold.eot);
	src:local('☺'),
		url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/otf/MathJax_Main-Bold.otf) format('opentype'),
		url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/svg/MathJax_Main-Bold.svg) format('svg');
}
@font-face {
	font-family: MathJax_Main-italic;
	src:url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/eot/MathJax_Main-Italic.eot);
	src:local('☺'),
		url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/otf/MathJax_Main-Italic.otf) format('opentype'),
		url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/svg/MathJax_Main-Italic.svg) format('svg');
}
@font-face {
	font-family: MathJax_Math;
	src:url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/eot/MathJax_Math.eot);
	src:local('☺'),
		url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/otf/MathJax_Math.otf) format('opentype'),
		url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/svg/MathJax_Math.svg) format('svg');
}
@font-face {
	font-family: MathJax_Math-italic;
	src:url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/eot/MathJax_Math-Italic.eot);
	src:local('☺'),
		url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/otf/MathJax_Math-Italic.otf) format('opentype'),
		url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/svg/MathJax_Math-Italic.svg) format('svg');
}
@font-face {
	font-family: MathJax_Caligraphic;
	src:url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/eot/MathJax_Caligraphic-Regular.eot);
	src:local('☺'),
		url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/otf/MathJax_Caligraphic-Regular.otf) format('opentype'),
		url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/svg/MathJax_Caligraphic-Regular.svg) format('svg');
}
@font-face {
	font-family: MathJax_Size1;
	src:url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/eot/MathJax_Size1-Regular.eot);
	src:local('☺'),
		url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/otf/MathJax_Size1-Regular.otf) format('opentype'),
		url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/svg/MathJax_Size1-Regular.svg) format('svg');
}
@font-face {
	font-family: MathJax_Size2;
	src:url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/eot/MathJax_Size2-Regular.eot);
	src:local('☺'),
		url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/otf/MathJax_Size2-Regular.otf) format('opentype'),
		url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/svg/MathJax_Size2-Regular.svg) format('svg');
}
@font-face {
	font-family: MathJax_Size3;
	src:url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/eot/MathJax_Size3-Regular.eot);
	src:local('☺'),
		url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/otf/MathJax_Size3-Regular.otf) format('opentype'),
		url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/svg/MathJax_Size3-Regular.svg) format('svg');
}
@font-face {
	font-family: MathJax_Size4;
	src:url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/eot/MathJax_Size4-Regular.eot);
	src:local('☺'),
		url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/otf/MathJax_Size4-Regular.otf) format('opentype'),
		url(http://playground.meekostuff.net/MathJax-fonts/mathjax/master/fonts/HTML-CSS/TeX/svg/MathJax_Size4-Regular.svg) format('svg');
}

</style>
<style>
.MathJax_Display {
	position: relative; text-align: center; margin: 1em 0em; width: 100%; display: block;
}
.MathJax {
	text-align: left; 
}
.MathJax .math span {
	font-family: MathJax_Main,MathJax_Size1,MathJax_AMS
}
</style>
<script>
if (config.noWebFonts) document.write('<style>.MathJax .math span { font-family: sans-serif !important;}</style>');
</script>
</head>
<body>
<h1>MathJax Layout Comparison</h1>
<form name="config">
<label>Equation
<select name="equation">
	<option value="">Select All</option>
	<option value="lorenz">The Lorenz Equations - IE8 generated</option>
	<option value="lorenzff">The Lorenz Equations - Firefox generated</option>
	<option value="lorenz3">The Lorenz Equations - Minimal styles</option>
	<option value="lorenz4">The Lorenz Equations - No spreaders + Min styles</option>
	<option value="lorenz2">The Lorenz Equations - Minimal elements</option>
	<option value="lorenz5">The Lorenz Equations - Blocky + Min elements</option>
</select>
</label>
<script id="lorenzff" type="text/html">
<div class="MathJax_Display" style="width: 100%; position: relative; text-align: center;" role="textbox" aria-readonly="true"><span class="MathJax" style=""><nobr class=""><span class="math" id="MathJax-Span-18"><span style="display: inline-block; position: relative; width: 7.321em; height: 0pt; font-size: 105%;"><span style="position: absolute; top: -2.786em; left: 0em; clip: rect(0.459em, 1000em, 4.661em, -0.348em);"><span class="mrow" id="MathJax-Span-19"><span class="mtable" id="MathJax-Span-20" style="padding-right: 0.1667em; padding-left: 0.1667em;"><span style="display: inline-block; position: relative; width: 7.004em; height: 0pt;"><span style="position: absolute; top: -2.786em; left: 0em; clip: rect(0.499em, 1000em, 4.468em, -0.515em);"><span style="display: inline-block; position: relative; width: 0.595em; height: 0pt;"><span style="position: absolute; top: -4.183em; clip: rect(1.895em, 1000em, 2.975em, -0.501em); right: 0em;"><span class="mtd" id="MathJax-Span-21"><span class="mrow" id="MathJax-Span-22"><span class="munderover" id="MathJax-Span-23"><span style="display: inline-block; position: relative; width: 0.595em; height: 0pt;"><span style="position: absolute; top: -2.786em; left: 0em; clip: rect(2.164em, 1000em, 2.975em, -0.501em);"><span class="mi" id="MathJax-Span-24" style="font-family: MathJax_Math; font-style: italic;">x</span><span style="display: inline-block; width: 0pt; height: 2.786em;"></span></span><span style="position: absolute; top: -2.829em; left: 0.087em; clip: rect(1.938em, 1000em, 2.415em, -0.346em);"><span class="mo" id="MathJax-Span-25" style="font-family: MathJax_Main;">˙</span><span style="display: inline-block; width: 0pt; height: 2.786em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0pt; height: 2.786em;"></span></span><span style="position: absolute; top: -2.721em; clip: rect(1.896em, 1000em, 3.169em, -0.515em); right: 0em;"><span class="mtd" id="MathJax-Span-35"><span class="mrow" id="MathJax-Span-36"><span class="munderover" id="MathJax-Span-37"><span style="display: inline-block; position: relative; width: 0.532em; height: 0pt;"><span style="position: absolute; top: -2.786em; left: 0em; clip: rect(2.165em, 1000em, 3.169em, -0.515em);"><span class="mi" id="MathJax-Span-38" style="font-family: MathJax_Math; font-style: italic;">y</span><span style="display: inline-block; width: 0pt; height: 2.786em;"></span></span><span style="position: absolute; top: -2.828em; left: 0.056em; clip: rect(1.938em, 1000em, 2.415em, -0.346em);"><span class="mo" id="MathJax-Span-39" style="font-family: MathJax_Main;">˙</span><span style="display: inline-block; width: 0pt; height: 2.786em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0pt; height: 2.786em;"></span></span><span style="position: absolute; top: -1.294em; clip: rect(1.896em, 1000em, 2.976em, -0.501em); right: 0em;"><span class="mtd" id="MathJax-Span-50"><span class="mrow" id="MathJax-Span-51"><span class="munderover" id="MathJax-Span-52"><span style="display: inline-block; position: relative; width: 0.532em; height: 0pt;"><span style="position: absolute; top: -2.786em; left: 0em; clip: rect(2.165em, 1000em, 2.976em, -0.501em);"><span class="mi" id="MathJax-Span-53" style="font-family: MathJax_Math; font-style: italic;">z</span><span style="display: inline-block; width: 0pt; height: 2.786em;"></span></span><span style="position: absolute; top: -2.828em; left: 0.056em; clip: rect(1.938em, 1000em, 2.415em, -0.346em);"><span class="mo" id="MathJax-Span-54" style="font-family: MathJax_Main;">˙</span><span style="display: inline-block; width: 0pt; height: 2.786em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0pt; height: 2.786em;"></span></span></span><span style="display: inline-block; width: 0pt; height: 2.786em;"></span></span><span style="position: absolute; top: -2.786em; left: 0.873em; clip: rect(0.459em, 1000em, 4.661em, -0.481em);"><span style="display: inline-block; position: relative; width: 6.131em; height: 0pt;"><span style="position: absolute; top: -4.183em; left: 0em; clip: rect(1.856em, 1000em, 3.215em, -0.481em);"><span class="mtd" id="MathJax-Span-26"><span class="mrow" id="MathJax-Span-27"><span class="mo" id="MathJax-Span-28" style="font-family: MathJax_Main;">=</span><span class="mi" id="MathJax-Span-29" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.278em;">σ</span><span class="mo" id="MathJax-Span-30" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-31" style="font-family: MathJax_Math; font-style: italic;">y</span><span class="mo" id="MathJax-Span-32" style="font-family: MathJax_Main; padding-left: 0.222em;">−</span><span class="mi" id="MathJax-Span-33" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.222em;">x</span><span class="mo" id="MathJax-Span-34" style="font-family: MathJax_Main;">)</span></span></span><span style="display: inline-block; width: 0pt; height: 2.786em;"></span></span><span style="position: absolute; top: -2.721em; left: 0em; clip: rect(2.164em, 1000em, 3.18em, -0.481em);"><span class="mtd" id="MathJax-Span-40"><span class="mrow" id="MathJax-Span-41"><span class="mo" id="MathJax-Span-42" style="font-family: MathJax_Main;">=</span><span class="mi" id="MathJax-Span-43" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.278em;">ρ</span><span class="mi" id="MathJax-Span-44" style="font-family: MathJax_Math; font-style: italic;">x</span><span class="mo" id="MathJax-Span-45" style="font-family: MathJax_Main; padding-left: 0.222em;">−</span><span class="mi" id="MathJax-Span-46" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.222em;">y</span><span class="mo" id="MathJax-Span-47" style="font-family: MathJax_Main; padding-left: 0.222em;">−</span><span class="mi" id="MathJax-Span-48" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.222em;">x</span><span class="mi" id="MathJax-Span-49" style="font-family: MathJax_Math; font-style: italic;">z</span></span></span><span style="display: inline-block; width: 0pt; height: 2.786em;"></span></span><span style="position: absolute; top: -1.294em; left: 0em; clip: rect(1.901em, 1000em, 3.169em, -0.481em);"><span class="mtd" id="MathJax-Span-55"><span class="mrow" id="MathJax-Span-56"><span class="mo" id="MathJax-Span-57" style="font-family: MathJax_Main;">=</span><span class="mo" id="MathJax-Span-58" style="font-family: MathJax_Main; padding-left: 0.278em;">−</span><span class="mi" id="MathJax-Span-59" style="font-family: MathJax_Math; font-style: italic;">β</span><span class="mi" id="MathJax-Span-60" style="font-family: MathJax_Math; font-style: italic;">z</span><span class="mo" id="MathJax-Span-61" style="font-family: MathJax_Main; padding-left: 0.222em;">+</span><span class="mi" id="MathJax-Span-62" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.222em;">x</span><span class="mi" id="MathJax-Span-63" style="font-family: MathJax_Math; font-style: italic;">y</span></span></span><span style="display: inline-block; width: 0pt; height: 2.786em;"></span></span></span><span style="display: inline-block; width: 0pt; height: 2.786em;"></span></span></span></span></span><span style="display: inline-block; width: 0pt; height: 2.786em;"></span></span></span><span style="border-left: 0em solid; display: inline-block; overflow: hidden; width: 0pt; height: 4.037em; vertical-align: -1.782em;"></span></span></nobr></span></div>
</script>
<script id="lorenz2" type="text/html">
<div class="MathJax_Display" style="width: 100%; text-align: center;"><span class="MathJax"><nobr><span class="math" style="display: inline-block; font-size: 105%; margin: 0pt auto;"><span class="mrow" style="display: inline-block;"><span class="mtable" style="display: inline-block;"><span style="display: inline-block; "><span class="mtd" style="display: block;"><span class="mrow"><span style="position: relative;" class="munderover"><span style="font-family: MathJax_Math-italic;" class="mi">x</span><span style="position: absolute; left: 0pt; font-family: MathJax_Main; top: -0.15em;" class="mo">˙</span></span></span></span><span class="mtd" style="display: block;"><span class="mrow"><span class="munderover" style="position: relative;"><span class="mi" style="font-family: MathJax_Math-italic;">y</span><span class="mo" style="position: absolute; left: 0pt; font-family: MathJax_Main; top: -0.15em;">˙</span></span></span></span><span class="mtd" style="display: block;"><span class="mrow"><span style="position: relative;" class="munderover"><span class="mi" style="font-family: MathJax_Math-italic;">z</span><span class="mo" style="position: absolute; left: 0pt; font-family: MathJax_Main; top: -0.15em;">˙</span></span></span></span></span><span style="display: inline-block; "><span style="display: block;" class="mtd"><span class="mrow"><span class="mo" style="font-family: MathJax_Main;">=</span><span class="mi" style="font-family: MathJax_Math-italic; padding-left: 0.278em;">σ</span><span class="mo" style="font-family: MathJax_Main;">(</span><span class="mi" style="font-family: MathJax_Math-italic;">y</span><span class="mo" style="font-family: MathJax_Main; padding-left: 0.222em;">−</span><span class="mi" style="font-family: MathJax_Math-italic; padding-left: 0.222em;">x</span><span class="mo" style="font-family: MathJax_Main;">)</span></span></span><span style="display: block;" class="mtd"><span class="mrow"><span class="mo" style="font-family: MathJax_Main;">=</span><span class="mi" style="font-family: MathJax_Math-italic; padding-left: 0.278em;">ρ</span><span class="mi" style="font-family: MathJax_Math-italic;">x</span><span class="mo" style="font-family: MathJax_Main; padding-left: 0.222em;">−</span><span class="mi" style="font-family: MathJax_Math-italic; padding-left: 0.222em;">y</span><span class="mo" style="font-family: MathJax_Main; padding-left: 0.222em;">−</span><span class="mi" style="font-family: MathJax_Math-italic; padding-left: 0.222em;">x</span><span class="mi" style="font-family: MathJax_Math-italic;">z</span></span></span><span style="display: block;" class="mtd"><span class="mrow"><span class="mo" style="font-family: MathJax_Main;">=</span><span class="mo" style="font-family: MathJax_Main; padding-left: 0.278em;">−</span><span class="mi" style="font-family: MathJax_Math-italic;">β</span><span class="mi" style="font-family: MathJax_Math-italic;">z</span><span class="mo" style="font-family: MathJax_Main; padding-left: 0.222em;">+</span><span class="mi" style="font-family: MathJax_Math-italic; padding-left: 0.222em;">x</span><span class="mi" style="font-family: MathJax_Math-italic;">y</span></span></span></span></span></span></span></nobr></span></div>
</script>
<script id="lorenz" type="text/html">
<DIV style="POSITION: relative; TEXT-ALIGN: center; WIDTH: 100%" class=MathJax_Display><SPAN class=MathJax><NOBR><SPAN class=math><SPAN style="WIDTH: 1px; DISPLAY: inline-block; HEIGHT: 0px; OVERFLOW: hidden; MARGIN-RIGHT: -1px"></SPAN><SPAN style="POSITION: relative; WIDTH: 7.44em; DISPLAY: inline-block; HEIGHT: 0px; FONT-SIZE: 116%"><SPAN style="POSITION: absolute; TOP: -2.18em; LEFT: 0em"><SPAN class=mrow><SPAN style="PADDING-LEFT: 0.16em; PADDING-RIGHT: 0.16em" class=mtable><SPAN style="WIDTH: 1px; DISPLAY: inline-block; HEIGHT: 0px; OVERFLOW: hidden; MARGIN-RIGHT: -1px"></SPAN><SPAN style="POSITION: relative; WIDTH: 7.13em; DISPLAY: inline-block; HEIGHT: 0px"><SPAN style="POSITION: absolute; TOP: -2.18em; LEFT: 0em"><SPAN style="WIDTH: 1px; DISPLAY: inline-block; HEIGHT: 0px; OVERFLOW: hidden; MARGIN-RIGHT: -1px"></SPAN><SPAN style="POSITION: relative; WIDTH: 0.59em; DISPLAY: inline-block; HEIGHT: 0px"><SPAN style="POSITION: absolute; TOP: -3.37em; RIGHT: -0.05em"><SPAN class=mtd><SPAN class=mrow><SPAN class=munderover><SPAN style="WIDTH: 1px; DISPLAY: inline-block; HEIGHT: 0px; OVERFLOW: hidden; MARGIN-RIGHT: -1px"></SPAN><SPAN style="POSITION: relative; WIDTH: 0.59em; DISPLAY: inline-block; HEIGHT: 0px"><SPAN style="POSITION: absolute; TOP: -2.18em; LEFT: 0em"><SPAN style="FONT-FAMILY: MathJax_Math-italic" class=mi scale="1">x</SPAN>&nbsp;<SPAN style="WIDTH: 0px; DISPLAY: inline-block; HEIGHT: 2.18em"></SPAN></SPAN><SPAN style="POSITION: absolute; TOP: -2.21em; LEFT: 0.08em"><SPAN style="FONT-FAMILY: MathJax_Main" class=mo scale="1">˙</SPAN>&nbsp;<SPAN style="WIDTH: 0px; DISPLAY: inline-block; HEIGHT: 2.18em"></SPAN></SPAN></SPAN></SPAN></SPAN></SPAN>&nbsp;<SPAN style="WIDTH: 0px; DISPLAY: inline-block; HEIGHT: 2.18em"></SPAN></SPAN><SPAN style="POSITION: absolute; TOP: -2.12em; RIGHT: -0.05em"><SPAN class=mtd><SPAN class=mrow><SPAN class=munderover><SPAN style="WIDTH: 1px; DISPLAY: inline-block; HEIGHT: 0px; OVERFLOW: hidden; MARGIN-RIGHT: -1px"></SPAN><SPAN style="POSITION: relative; WIDTH: 0.54em; DISPLAY: inline-block; HEIGHT: 0px"><SPAN style="POSITION: absolute; TOP: -2.18em; LEFT: 0em"><SPAN style="FONT-FAMILY: MathJax_Math-italic" class=mi scale="1">y</SPAN>&nbsp;<SPAN style="WIDTH: 0px; DISPLAY: inline-block; HEIGHT: 2.18em"></SPAN><SPAN style="WIDTH: 0.1em; DISPLAY: inline-block; HEIGHT: 1px; OVERFLOW: hidden"></SPAN></SPAN><SPAN style="POSITION: absolute; TOP: -2.21em; LEFT: 0.05em"><SPAN style="FONT-FAMILY: MathJax_Main" class=mo scale="1">˙</SPAN>&nbsp;<SPAN style="WIDTH: 0px; DISPLAY: inline-block; HEIGHT: 2.18em"></SPAN></SPAN></SPAN></SPAN></SPAN></SPAN>&nbsp;<SPAN style="WIDTH: 0px; DISPLAY: inline-block; HEIGHT: 2.18em"></SPAN></SPAN><SPAN style="POSITION: absolute; TOP: -0.9em; RIGHT: -0.04em"><SPAN class=mtd><SPAN class=mrow><SPAN class=munderover><SPAN style="WIDTH: 1px; DISPLAY: inline-block; HEIGHT: 0px; OVERFLOW: hidden; MARGIN-RIGHT: -1px"></SPAN><SPAN style="POSITION: relative; WIDTH: 0.54em; DISPLAY: inline-block; HEIGHT: 0px"><SPAN style="POSITION: absolute; TOP: -2.18em; LEFT: 0em"><SPAN style="FONT-FAMILY: MathJax_Math-italic" class=mi scale="1">z</SPAN>&nbsp;<SPAN style="WIDTH: 0px; DISPLAY: inline-block; HEIGHT: 2.18em"></SPAN><SPAN style="WIDTH: 0.1em; DISPLAY: inline-block; HEIGHT: 1px; OVERFLOW: hidden"></SPAN></SPAN><SPAN style="POSITION: absolute; TOP: -2.21em; LEFT: 0.05em"><SPAN style="FONT-FAMILY: MathJax_Main" class=mo scale="1">˙</SPAN>&nbsp;<SPAN style="WIDTH: 0px; DISPLAY: inline-block; HEIGHT: 2.18em"></SPAN></SPAN></SPAN></SPAN></SPAN></SPAN>&nbsp;<SPAN style="WIDTH: 0px; DISPLAY: inline-block; HEIGHT: 2.18em"></SPAN></SPAN></SPAN>&nbsp;<SPAN style="WIDTH: 0px; DISPLAY: inline-block; HEIGHT: 2.18em"></SPAN></SPAN><SPAN style="POSITION: absolute; TOP: -2.18em; LEFT: 0.87em"><SPAN style="WIDTH: 1px; DISPLAY: inline-block; HEIGHT: 0px; OVERFLOW: hidden; MARGIN-RIGHT: -1px"></SPAN><SPAN style="POSITION: relative; WIDTH: 6.25em; DISPLAY: inline-block; HEIGHT: 0px"><SPAN style="POSITION: absolute; TOP: -3.37em; LEFT: 0em"><SPAN class=mtd><SPAN class=mrow><SPAN style="FONT-FAMILY: MathJax_Main" class=mo scale="1">=</SPAN><SPAN style="PADDING-LEFT: 0.27em; FONT-FAMILY: MathJax_Math-italic" class=mi scale="1">σ</SPAN><SPAN style="FONT-FAMILY: MathJax_Main" class=mo scale="1">(</SPAN><SPAN style="FONT-FAMILY: MathJax_Math-italic" class=mi scale="1">y</SPAN><SPAN style="PADDING-LEFT: 0.22em; FONT-FAMILY: MathJax_Main" class=mo scale="1">−</SPAN><SPAN style="PADDING-LEFT: 0.22em; FONT-FAMILY: MathJax_Math-italic" class=mi scale="1">x</SPAN><SPAN style="FONT-FAMILY: MathJax_Main" class=mo scale="1">)</SPAN></SPAN></SPAN>&nbsp;<SPAN style="WIDTH: 0px; DISPLAY: inline-block; HEIGHT: 2.18em"></SPAN></SPAN><SPAN style="POSITION: absolute; TOP: -2.12em; LEFT: 0em"><SPAN class=mtd><SPAN class=mrow><SPAN style="FONT-FAMILY: MathJax_Main" class=mo scale="1">=</SPAN><SPAN style="PADDING-LEFT: 0.27em; FONT-FAMILY: MathJax_Math-italic" class=mi scale="1">ρ</SPAN><SPAN style="FONT-FAMILY: MathJax_Math-italic" class=mi scale="1">x</SPAN><SPAN style="PADDING-LEFT: 0.22em; FONT-FAMILY: MathJax_Main" class=mo scale="1">−</SPAN><SPAN style="PADDING-LEFT: 0.22em; FONT-FAMILY: MathJax_Math-italic" class=mi scale="1">y</SPAN><SPAN style="PADDING-LEFT: 0.22em; FONT-FAMILY: MathJax_Main" class=mo scale="1">−</SPAN><SPAN style="PADDING-LEFT: 0.22em; FONT-FAMILY: MathJax_Math-italic" class=mi scale="1">x</SPAN><SPAN style="FONT-FAMILY: MathJax_Math-italic" class=mi scale="1">z</SPAN></SPAN></SPAN>&nbsp;<SPAN style="WIDTH: 0px; DISPLAY: inline-block; HEIGHT: 2.18em"></SPAN><SPAN style="WIDTH: 0.1em; DISPLAY: inline-block; HEIGHT: 1px; OVERFLOW: hidden"></SPAN></SPAN><SPAN style="POSITION: absolute; TOP: -0.9em; LEFT: 0em"><SPAN class=mtd><SPAN class=mrow><SPAN style="FONT-FAMILY: MathJax_Main" class=mo scale="1">=</SPAN><SPAN style="PADDING-LEFT: 0.27em; FONT-FAMILY: MathJax_Main" class=mo scale="1">−</SPAN><SPAN style="FONT-FAMILY: MathJax_Math-italic" class=mi scale="1">β</SPAN><SPAN style="FONT-FAMILY: MathJax_Math-italic" class=mi scale="1">z</SPAN><SPAN style="PADDING-LEFT: 0.22em; FONT-FAMILY: MathJax_Main" class=mo scale="1">+</SPAN><SPAN style="PADDING-LEFT: 0.22em; FONT-FAMILY: MathJax_Math-italic" class=mi scale="1">x</SPAN><SPAN style="FONT-FAMILY: MathJax_Math-italic" class=mi scale="1">y</SPAN></SPAN></SPAN>&nbsp;<SPAN style="WIDTH: 0px; DISPLAY: inline-block; HEIGHT: 2.18em"></SPAN><SPAN style="WIDTH: 0.1em; DISPLAY: inline-block; HEIGHT: 1px; OVERFLOW: hidden"></SPAN></SPAN></SPAN>&nbsp;<SPAN style="WIDTH: 0px; DISPLAY: inline-block; HEIGHT: 2.18em"></SPAN><SPAN style="WIDTH: 0.1em; DISPLAY: inline-block; HEIGHT: 1px; OVERFLOW: hidden"></SPAN></SPAN></SPAN></SPAN></SPAN>&nbsp;<SPAN style="WIDTH: 0px; DISPLAY: inline-block; HEIGHT: 2.18em"></SPAN></SPAN></SPAN><SPAN style="BORDER-LEFT: 0em solid; WIDTH: 0px; DISPLAY: inline-block; HEIGHT: 3.96em; VERTICAL-ALIGN: -1.72em; OVERFLOW: hidden"></SPAN></SPAN></NOBR></SPAN></DIV>
</script>
<script id="lorenz3" type="text/html">
<div class="MathJax_Display" style="width: 100%; position: relative; text-align: center;" role="textbox" aria-readonly="true"><span class="MathJax"><nobr><span class="math"><span><span><span class="mrow"><span class="mtable"><span><span style="display: inline-block; "><span style="display: inline-block;"><span style="display: block;"><span class="mtd"><span class="mrow"><span class="munderover"><span style="position: relative; "><span><span class="mi" style="font-family: MathJax_Math; font-style: italic;">x</span><span style="display: inline-block; width: 0pt; height: 1em;"></span></span><span style="position: absolute; top: -0.19em; left: 0.087em; "><span class="mo" style="font-family: MathJax_Main;">˙</span><span style="display: inline-block; width: 0pt; height: 1em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0pt; height: 1em;"></span></span><span style="display: block;"><span class="mtd"><span class="mrow"><span class="munderover"><span style="position: relative;"><span><span class="mi" style="font-family: MathJax_Math; font-style: italic;">y</span><span style="display: inline-block; width: 0pt; height: 1em;"></span></span><span style="position: absolute; top: -0.18em; left: 0.056em; "><span class="mo" style="font-family: MathJax_Main;">˙</span><span style="display: inline-block; width: 0pt; height: 1em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0pt; height: 1em;"></span></span><span style="display: block;"><span class="mtd"><span class="mrow"><span class="munderover"><span style="position: relative; "><span><span class="mi" style="font-family: MathJax_Math; font-style: italic;">z</span><span style="display: inline-block; width: 0pt; height: 1em;"></span></span><span style="position: absolute; top: -0.18em; left: 0.056em; "><span class="mo" style="font-family: MathJax_Main;">˙</span><span style="display: inline-block; width: 0pt; height: 1em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0pt; height: 1em;"></span></span></span><span style="display: inline-block; width: 0pt; height: 1em;"></span></span><span style="display: inline-block"><span style="display: inline-block;"><span><span class="mtd"><span class="mrow"><span class="mo" style="font-family: MathJax_Main;">=</span><span class="mi" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.278em;">σ</span><span class="mo" style="font-family: MathJax_Main;">(</span><span class="mi" style="font-family: MathJax_Math; font-style: italic;">y</span><span class="mo" style="font-family: MathJax_Main; padding-left: 0.222em;">−</span><span class="mi" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.222em;">x</span><span class="mo" style="font-family: MathJax_Main;">)</span></span></span><span style="display: inline-block; width: 0pt; height: 1em;"></span></span><span style="display: block;"><span class="mtd"><span class="mrow"><span class="mo" style="font-family: MathJax_Main;">=</span><span class="mi" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.278em;">ρ</span><span class="mi" style="font-family: MathJax_Math; font-style: italic;">x</span><span class="mo" style="font-family: MathJax_Main; padding-left: 0.222em;">−</span><span class="mi" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.222em;">y</span><span class="mo" style="font-family: MathJax_Main; padding-left: 0.222em;">−</span><span class="mi" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.222em;">x</span><span class="mi" style="font-family: MathJax_Math; font-style: italic;">z</span></span></span><span style="display: inline-block; width: 0pt; height: 1em;"></span></span><span style="display: block;"><span class="mtd"><span class="mrow"><span class="mo" style="font-family: MathJax_Main;">=</span><span class="mo" style="font-family: MathJax_Main; padding-left: 0.278em;">−</span><span class="mi" style="font-family: MathJax_Math; font-style: italic;">β</span><span class="mi" style="font-family: MathJax_Math; font-style: italic;">z</span><span class="mo" style="font-family: MathJax_Main; padding-left: 0.222em;">+</span><span class="mi" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.222em;">x</span><span class="mi" style="font-family: MathJax_Math; font-style: italic;">y</span></span></span><span style="display: inline-block; width: 0pt; height: 1em;"></span></span></span><span style="display: inline-block; width: 0pt; height: 1em;"></span></span></span></span></span><span style="display: inline-block; width: 0pt; height: 1em;"></span></span></span><span style="border-left: 0em solid; display: inline-block; overflow: hidden; width: 0pt;"></span></span></nobr></span></div>
</script>
<script id="lorenz4" type="text/html">
<div class="MathJax_Display" style="width: 100%; position: relative; text-align: center;" role="textbox" aria-readonly="true"><span class="MathJax"><nobr><span class="math"><span><span><span class="mrow"><span class="mtable"><span><span style="display: inline-block; "><span><span style="display: block;"><span class="mtd"><span class="mrow"><span class="munderover"><span style="position: relative; "><span><span class="mi" style="font-family: MathJax_Math; font-style: italic;">x</span></span><span style="position: absolute; top: -0.19em; left: 0.087em; "><span class="mo" style="font-family: MathJax_Main;">˙</span></span></span></span></span></span></span><span style="display: block;"><span class="mtd"><span class="mrow"><span class="munderover"><span style="position: relative;"><span><span class="mi" style="font-family: MathJax_Math; font-style: italic;">y</span></span><span style="position: absolute; top: -0.18em; left: 0.056em; "><span class="mo" style="font-family: MathJax_Main;">˙</span></span></span></span></span></span></span><span style="display: block;"><span class="mtd"><span class="mrow"><span class="munderover"><span style="position: relative; "><span><span class="mi" style="font-family: MathJax_Math; font-style: italic;">z</span></span><span style="position: absolute; top: -0.18em; left: 0.056em; "><span class="mo" style="font-family: MathJax_Main;">˙</span></span></span></span></span></span></span></span></span><span style="display: inline-block"><span><span style="display: block;"><span class="mtd"><span class="mrow"><span class="mo" style="font-family: MathJax_Main;">=</span><span class="mi" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.278em;">σ</span><span class="mo" style="font-family: MathJax_Main;">(</span><span class="mi" style="font-family: MathJax_Math; font-style: italic;">y</span><span class="mo" style="font-family: MathJax_Main; padding-left: 0.222em;">−</span><span class="mi" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.222em;">x</span><span class="mo" style="font-family: MathJax_Main;">)</span></span></span></span><span style="display: block;"><span class="mtd"><span class="mrow"><span class="mo" style="font-family: MathJax_Main;">=</span><span class="mi" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.278em;">ρ</span><span class="mi" style="font-family: MathJax_Math; font-style: italic;">x</span><span class="mo" style="font-family: MathJax_Main; padding-left: 0.222em;">−</span><span class="mi" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.222em;">y</span><span class="mo" style="font-family: MathJax_Main; padding-left: 0.222em;">−</span><span class="mi" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.222em;">x</span><span class="mi" style="font-family: MathJax_Math; font-style: italic;">z</span></span></span></span><span style="display: block;"><span class="mtd"><span class="mrow"><span class="mo" style="font-family: MathJax_Main;">=</span><span class="mo" style="font-family: MathJax_Main; padding-left: 0.278em;">−</span><span class="mi" style="font-family: MathJax_Math; font-style: italic;">β</span><span class="mi" style="font-family: MathJax_Math; font-style: italic;">z</span><span class="mo" style="font-family: MathJax_Main; padding-left: 0.222em;">+</span><span class="mi" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.222em;">x</span><span class="mi" style="font-family: MathJax_Math; font-style: italic;">y</span></span></span></span></span></span></span></span></span></span></span></span></nobr></span></div>
</script>
<script id="lorenz5" type="text/html">
<div class="MathJax_Display" style="width: 100%; text-align: center;"><span class="MathJax" style="display: inline-block;"><nobr style="display: block;"><span class="math" style="display: inline-block; font-size: 105%; margin: 0pt auto;"><span class="mrow" style="display: inline-block;"><span class="mtable" style="display: inline-block;"><span style="display: inline-block; "><span class="mtd" style="display: block;"><span class="mrow" style="display: block;"><span class="munderover"><span style="font-family: MathJax_Math-italic;" class="mi">x</span><span style="font-family: MathJax_Main; margin-left: -1ex; position: relative; top: -0.1em;" class="mo">˙</span></span></span></span><span class="mtd" style="display: block;"><span class="mrow" style="display: block;"><span class="munderover"><span class="mi" style="font-family: MathJax_Math-italic;">y</span><span class="mo" style="margin-left: -1ex; position: relative; top: -0.1em; font-family: MathJax_Main; top: -0.15em;">˙</span></span></span></span><span class="mtd" style="display: block;"><span class="mrow" style="display: block;"><span class="munderover"><span class="mi" style="font-family: MathJax_Math-italic;">z</span><span class="mo" style="margin-left: -1ex; position: relative; top: -0.1em; font-family: MathJax_Main; top: -0.15em;">˙</span></span></span></span></span><span style="display: inline-block; "><span style="display: block;" class="mtd"><span class="mrow" style="display: block;"><span class="mo" style="font-family: MathJax_Main;">=</span><span class="mi" style="font-family: MathJax_Math-italic; padding-left: 0.278em;">σ</span><span class="mo" style="font-family: MathJax_Main;">(</span><span class="mi" style="font-family: MathJax_Math-italic;">y</span><span class="mo" style="font-family: MathJax_Main; padding-left: 0.222em;">−</span><span class="mi" style="font-family: MathJax_Math-italic; padding-left: 0.222em;">x</span><span class="mo" style="font-family: MathJax_Main;">)</span></span></span><span style="display: block;" class="mtd"><span class="mrow" style="display: block;"><span class="mo" style="font-family: MathJax_Main;">=</span><span class="mi" style="font-family: MathJax_Math-italic; padding-left: 0.278em;">ρ</span><span class="mi" style="font-family: MathJax_Math-italic;">x</span><span class="mo" style="font-family: MathJax_Main; padding-left: 0.222em;">−</span><span class="mi" style="font-family: MathJax_Math-italic; padding-left: 0.222em;">y</span><span class="mo" style="font-family: MathJax_Main; padding-left: 0.222em;">−</span><span class="mi" style="font-family: MathJax_Math-italic; padding-left: 0.222em;">x</span><span class="mi" style="font-family: MathJax_Math-italic;">z</span></span></span><span style="display: block;" class="mtd"><span class="mrow" style="display: block;"><span class="mo" style="font-family: MathJax_Main;">=</span><span class="mo" style="font-family: MathJax_Main; padding-left: 0.278em;">−</span><span class="mi" style="font-family: MathJax_Math-italic;">β</span><span class="mi" style="font-family: MathJax_Math-italic;">z</span><span class="mo" style="font-family: MathJax_Main; padding-left: 0.222em;">+</span><span class="mi" style="font-family: MathJax_Math-italic; padding-left: 0.222em;">x</span><span class="mi" style="font-family: MathJax_Math-italic;">y</span></span></span></span></span></span></span></nobr></span></div>
</script>

<label title="How many equations to place in test page">Count <input type="text" size="4" name="count" /></label>
<input type="submit" name="run" value="Run" /><br />

<fieldset><legend>Rebuild options</legend>
<label class="exploratory" title="Disable Web Fonts - rely on browser default font.">No Web Fonts <input type="checkbox" name="noWebFonts" /></label>
<label title="Perform dimension lookups, element bookends, etc in batches as appropriate">Batch <input type="checkbox" name="batch" /></label>
<label title="Frame for math DOM uses fixed positioning during layout">Fixed frame <input type="checkbox" name="fixedPosFrame" /></label>
<label class="exploratory" title="The math DOM is removed from the document during layout. All measurements should be zero.">Math removed <input type="checkbox" name="mathRemoved" /></label>
<label title="Wrappers for math pseudo-elements are absolutely positioned">Absolute <input type="checkbox" name="absPosWrapper" /></label>
<label title="Wrappers for math pseudo-elements are divs not spans">Use DIVs <input type="checkbox" name="divWrapper" /></label>
<label>Bookend <input type="text" size="40" name="bookend" disabled /></label>
</fieldset>
<label>documentMode <input type="text" name="documentMode" disabled /></label>
<label>compatMode <input type="text" name="compatMode" disabled /></label>
</form>
<script>
(function() {

var form = document.forms["config"];
Array.forEach(form["equation"].options, function(option) {
	if (option.value === config.equation) option.selected = true;
});
Array.forEach("count bookend".split(/\s+/), function(name) {
	form[name].value = config[name];
});
Array.forEach("batch absPosWrapper divWrapper fixedPosFrame mathRemoved noWebFonts".split(/\s+/), function(name) {
	form[name].checked = !!config[name];
});
Array.forEach("documentMode compatMode".split(/\s+/), function(name) {
	form[name].setAttribute("value", document[name]);
});
})();
</script>

<fieldset><legend>Messages</legend>
<p id="message">Click "Run" to start</p>
</fieldset>

<table id="table">
	<caption>Equation Processing Stats</caption>
	<thead>
		<tr>
			<th>Eqn #</th>
			<th title="Number of elements in the MathML pseudo-DOM tree">Size </th>
			<th title="Height of the MathML pseudo-DOM tree">Height</th>
			<th title="Size / Height">Ratio</th>
			<th title="Statting and wrapping the DOM tree">Prepare (ms)</th>
			<th title="Dimension lookups and finalizing the DOM tree">Adjust (ms)</th>
			<th title="Prepare + Adjust">Rebuild (ms)</th>
			<th title="Cumulative offsetHeight">offsetHeight</th>
			<th title="Cumulative offsetWidth">offsetWidth</th>
		</tr>
	</thead>
	<tbody>
		<tr class="template"><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
	</tbody>
</table>
<hr />
<div id="runbox">

<script>
(function() {

var form = document.forms["config"], select = form["equation"];
var math = "", all = select.options[0].selected;
Array.forEach(select.options, function(option) {
	var equation = option.value;
	if (!equation) return;
	if (!all && !option.selected) return;
	var script = $("#" + equation);
	math += script.innerHTML + '\n';
});
for (var i=0; i<config.count; i++) document.write(math);

})();
</script>

</div>
</body>
<script>

// Box works by wrapping an element of interest, for the purpose of measuring and padding
// When the box is finalized in the DOM the element is inserted before the wrapper and the wrapper removed from the DOM

var Box = {

isMathElement: function(node) {
	if (node.nodeType !== 1) return false;
	var className = node.className;
	return (className && className !== "MathJax_strut");
},

wrapElement: (config.divWrapper) ? "div" : "span",

methodOrder: "Measure Pad Measure Finalize".split(" "),

Wrap: function(element) {
	var parent = element.parentNode;
	var wrapper = document.createElement(Box.wrapElement);
	if (config.absPosWrapper) wrapper.style.cssText = "position: absolute; top: 0px; left: 0px;";
	parent.insertBefore(wrapper, element);
	wrapper.appendChild(element);
	return wrapper;
},

Finalize: function(element) {
	var wrapper = element.parentNode;
	var parent = wrapper.parentNode;
	parent.insertBefore(element, wrapper);
	/*
	 NOTE lookupStyles is not an advertized option.
	 - it is impossible to tell whether it just works out the camputedStyle, or also does a reflow
	 - in Firefox it is negligible, in Opera it increases the rebuilding time by 25%.
	 - probably it is insignificant when it doesn't cause a reflow
	 - it will break when using pieceWise rebuilding
	*/
	if (config.lookupStyles) { 
		var style = (window.getComputedStyle) ? window.getComputedStyle(element, null) : element.currentStyle;
		var text = style.textAlign; // [ style.position, style.display, style.borderLeft, style.textAlign ] .join(" ");
	}
	parent.removeChild(wrapper);
},

Measure: function(element, equation) { // FIXME orthogonality
	var wrapper = element.parentNode;
	equation.offsetWidth += element.offsetWidth;
	equation.offsetHeight += element.offsetHeight;
},

Pad: function(element) {
	var wrapper = element.parentNode;
	var strut = document.createElement("div");
	strut.innerHTML = config.bookend;
	for (var node=strut.firstChild; node; node=node.nextSibling) wrapper.appendChild(node);
}


}

var Equation = function(div) {
	this.display = div;
	this.offsetWidth = 0;
	this.offsetHeight = 0;
}

Equation.prototype = {

Prepare: function() {
	this.frame = $$("nobr", this.display)[0];

	var frag = this.frag = document.createDocumentFragment();
	frag.appendChild(this.frame.firstChild);
	
	// traverse the tree creating a nodeMap of the depth of math elements 
	var nodeMap = [];
	var level = 0, size = 0;
	var processElement = function(element) {
		var isMath = Box.isMathElement(element);
		if (isMath) {
			size++;
			if (!nodeMap[level]) nodeMap[level] = [];
			nodeMap[level].push(element);
			level++;
		}
		for (var node=element.firstChild; node; node=node.nextSibling) {
			if (node.nodeType === 1) processElement(node);
		}
		if (isMath) level--;
	}
	processElement(frag.firstChild);
//	log("Exit level (should be 0): " + level);
	this.nodeMap = nodeMap = nodeMap.reverse();
	this.height = nodeMap.length;
	this.size = size;
	
	// wrap all math elements
	Array.forEach(nodeMap, function(nodes) {
		Array.forEach(nodes, function(node) {
			Box.Wrap(node);
		});
	});

	if (config.fixedPosFrame) {
		this.frame.style.cssText = "width: 0px; height: 0px; visbility: hidden; overflow: hidden; position: fixed; top: 0px; left: 0px; ";
	}
	if (!config.mathRemoved) {		
		this.frame.appendChild(this.frag.firstChild);
		delete this.frag;
	}
},

Adjust: function() {
	var equation = this;
	var methods = Box.methodOrder;
	Array.forEach (this.nodeMap, function(nodes) {
	if (config.batch) {
		Array.forEach(methods, function(fnname) {
			Array.forEach(nodes, function(node) {
				Box[fnname](node, equation);
			});
		});
	}
	else {
		Array.forEach(nodes, function(node) {
			Array.forEach(methods, function(fnname) {
				Box[fnname](node, equation);
			});
		});
	}
	});
	delete this.nodeMap;
	if (config.fixedPosFrame) {
		this.frame.style.cssText = null;
	}
	if (config.mathRemoved) {		
		this.frame.appendChild(this.frag.firstChild);
		delete this.frag;
	}
}

}


var Init = function() {

$("#message").innerHTML = "Processing now";

var timeStamps = [];
var eqnList = [];
var tBody = $("#table").tBodies[0];

var total = {
	size : 0,
	height : 0,
	process: 0,
	prepare: 0,
	adjust: 0
}

var queue = new mui.Queue(50);

Array.forEach($$("div", $("#runbox")), function(div, eqnIndex) {
	var eqn = new Equation(div);
	eqnList.push(eqn);		
	queue.Push(function() {	
		var t = timeStamps;
		t[0] = Date.now();
		eqn.Prepare();
		t[1] = Date.now();
		eqn.Adjust();
		t[2] = Date.now();
		var template = tBody.rows[tBody.rows.length - 1];
		var row = template.cloneNode(true);
		tBody.insertBefore(row, template);
		row.className = "";
		var prepTime =  t[1] - t[0], adjustTime = t[2] - t[1];
		var data = [ (eqnIndex + 1), eqn.size, eqn.height, Math.round(eqn.size * 100 / eqn.height) / 100, prepTime, adjustTime, (prepTime + adjustTime), eqn.offsetHeight, eqn.offsetWidth ];
		Array.forEach(row.cells, function(cell, i) {
			cell.innerHTML = data[i];
		});
		total.size += eqn.size;
		total.height += eqn.height;
		total.prepare += prepTime;
		total.adjust += adjustTime;
	});
});

queue.Push(function() {
	var row = tBody.rows[tBody.rows.length - 1];
	row.className = "";
	var data = [ "Totals", total.size, total.height, Math.round(total.size * 100 / total.height) / 100, total.prepare, total.adjust, (total.prepare + total.adjust) ];
	Array.forEach(row.cells, function(cell, i) {
		if (data[i] != null) cell.innerHTML = data[i];
	});
	$("#message").innerHTML = "Processing Complete"
});

}

if (config.run) {
	$("#message").innerHTML = "There is a five second delay before processing to give time for fonts to download";
	window.setTimeout(Init, 5000); // long timeout hoping the fonts are loaded
}
</script>
</html>
